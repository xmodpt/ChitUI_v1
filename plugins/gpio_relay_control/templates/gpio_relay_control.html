<!-- Load FontAwesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<!-- GPIO Relay Control Buttons -->
<div class="d-flex gap-2" id="gpio-relay-buttons">
    <button type="button" class="btn btn-sm gpio-relay-btn relay-off" id="relay1-btn" data-relay="1" title="Relay 1" style="display: none;">
        <i class="fa-solid fa-bolt"></i>
        <span class="relay-text ms-1">R1</span>
    </button>
    <button type="button" class="btn btn-sm gpio-relay-btn relay-off" id="relay2-btn" data-relay="2" title="Relay 2" style="display: none;">
        <i class="fa-solid fa-power-off"></i>
        <span class="relay-text ms-1">R2</span>
    </button>
    <button type="button" class="btn btn-sm gpio-relay-btn relay-off" id="relay3-btn" data-relay="3" title="Relay 3" style="display: none;">
        <i class="fa-solid fa-fan"></i>
        <span class="relay-text ms-1">R3</span>
    </button>
    <button type="button" class="btn btn-sm gpio-relay-btn relay-off" id="relay4-btn" data-relay="4" title="Relay 4" style="display: none;">
        <i class="fa-solid fa-lightbulb"></i>
        <span class="relay-text ms-1">R4</span>
    </button>
</div>

<style>
/* Active relay state - orange */
#relay1-btn.relay-on,
#relay2-btn.relay-on,
#relay3-btn.relay-on,
#relay4-btn.relay-on {
    background-color: #ff8c00 !important;
    border-color: #ff8c00 !important;
    color: white !important;
}

/* Inactive relay state - gray */
#relay1-btn.relay-off,
#relay2-btn.relay-off,
#relay3-btn.relay-off,
#relay4-btn.relay-off {
    background-color: #6c757d !important;
    border-color: #6c757d !important;
    color: white !important;
}

/* Hover effects */
.gpio-relay-btn:hover {
    opacity: 0.85;
}

/* Hide text class */
.relay-text.hidden {
    display: none !important;
}

/* Responsive: hide text on small screens */
@media (max-width: 768px) {
    .relay-text {
        display: none;
    }
}
</style>

<script>
(function() {
    'use strict';

    // Plugin state
    const relayConfig = {
        relay1: { name: 'Relay 1', icon: 'fa-bolt', type: 'NO', state: false, enabled: true, show_label: true },
        relay2: { name: 'Relay 2', icon: 'fa-power-off', type: 'NO', state: false, enabled: true, show_label: true },
        relay3: { name: 'Relay 3', icon: 'fa-fan', type: 'NO', state: false, enabled: true, show_label: true },
        relay4: { name: 'Relay 4', icon: 'fa-lightbulb', type: 'NO', state: false, enabled: true, show_label: true },
        show_text: true
    };

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeRelayControl);
    } else {
        initializeRelayControl();
    }

    function initializeRelayControl() {
        console.log('[GPIO Relay] Initializing GPIO Relay Control plugin');

        // Setup button click handlers
        for (let i = 1; i <= 4; i++) {
            const btn = document.getElementById(`relay${i}-btn`);
            if (btn) {
                console.log(`[GPIO Relay] Found button relay${i}-btn, adding click handler`);
                btn.addEventListener('click', function(e) {
                    console.log(`[GPIO Relay] Button ${i} clicked!`);
                    e.preventDefault();
                    toggleRelay(i);
                });
            } else {
                console.error(`[GPIO Relay] Button relay${i}-btn NOT FOUND!`);
            }
        }

        // Setup Socket.IO listeners if available
        if (typeof socket !== 'undefined') {
            socket.on('gpio_relay_state_changed', function(data) {
                console.log('Relay state changed:', data);
                updateRelayButton(data.relay, data.state);
            });

            socket.on('gpio_relay_status', function(data) {
                console.log('Relay status received:', data);
                updateAllRelayButtons(data);
            });

            socket.on('gpio_relay_config_updated', function(config) {
                console.log('Config updated:', config);
                loadConfiguration(config);
            });
        }

        // Load initial status
        loadRelayStatus();
    }

    function loadRelayStatus() {
        fetch('/plugin/gpio_relay_control/status')
            .then(response => response.json())
            .then(data => {
                console.log('Initial status loaded:', data);
                updateAllRelayButtons(data);
            })
            .catch(error => {
                console.error('Error loading relay status:', error);
            });

        // Load configuration
        fetch('/plugin/gpio_relay_control/config')
            .then(response => response.json())
            .then(config => {
                console.log('Configuration loaded:', config);
                loadConfiguration(config);
            })
            .catch(error => {
                console.error('Error loading config:', error);
            });
    }

    function loadConfiguration(config) {
        // Update relay configurations
        for (let i = 1; i <= 4; i++) {
            relayConfig[`relay${i}`].name = config[`relay${i}_name`] || `Relay ${i}`;
            relayConfig[`relay${i}`].icon = config[`relay${i}_icon`] || 'fa-bolt';
            relayConfig[`relay${i}`].type = config[`relay${i}_type`] || 'NO';
            relayConfig[`relay${i}`].enabled = config[`relay${i}_enabled`] !== false;
            relayConfig[`relay${i}`].show_label = config[`relay${i}_show_label`] !== false;
        }
        relayConfig.show_text = config.show_text !== false;

        // Update button display
        updateButtonAppearance();
    }

    function updateButtonAppearance() {
        for (let i = 1; i <= 4; i++) {
            const btn = document.getElementById(`relay${i}-btn`);
            if (!btn) continue;

            const config = relayConfig[`relay${i}`];

            // Show/hide button based on enabled state
            if (config.enabled) {
                btn.style.display = '';
            } else {
                btn.style.display = 'none';
            }

            // Update icon
            const icon = btn.querySelector('i');
            if (icon) {
                icon.className = `fa-solid ${config.icon}`;
            }

            // Update text
            const textSpan = btn.querySelector('.relay-text');
            if (textSpan) {
                textSpan.textContent = config.name;
                // Use per-relay show_label setting, with fallback to global show_text
                if (config.show_label && relayConfig.show_text) {
                    textSpan.classList.remove('hidden');
                } else {
                    textSpan.classList.add('hidden');
                }
            }

            // Update tooltip
            btn.title = `${config.name} (${config.type}) - ${config.state ? 'ON' : 'OFF'}`;
        }
    }

    function toggleRelay(relayNum) {
        console.log(`[GPIO Relay] toggleRelay called for relay ${relayNum}`);
        const btn = document.getElementById(`relay${relayNum}-btn`);
        if (!btn) {
            console.error(`[GPIO Relay] Button not found for relay ${relayNum}`);
            return;
        }

        // Disable button during request
        btn.disabled = true;
        console.log(`[GPIO Relay] Sending POST to /plugin/gpio_relay_control/relay/${relayNum}/toggle`);

        fetch(`/plugin/gpio_relay_control/relay/${relayNum}/toggle`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            console.log(`[GPIO Relay] Response received:`, response.status, response.statusText);
            return response.json();
        })
        .then(data => {
            console.log(`[GPIO Relay] Response data:`, data);
            if (data.success) {
                updateRelayButton(relayNum, data.state);
                console.log(`[GPIO Relay] Relay ${relayNum} toggled to ${data.state ? 'ON' : 'OFF'}`);
            } else {
                console.error('[GPIO Relay] Failed to toggle relay:', data);
            }
        })
        .catch(error => {
            console.error('[GPIO Relay] Error toggling relay:', error);
        })
        .finally(() => {
            btn.disabled = false;
            console.log(`[GPIO Relay] Button re-enabled`);
        });
    }

    function updateRelayButton(relayNum, state) {
        const btn = document.getElementById(`relay${relayNum}-btn`);
        if (!btn) return;

        relayConfig[`relay${relayNum}`].state = state;

        // Update button classes
        if (state) {
            btn.classList.remove('relay-off');
            btn.classList.add('relay-on');
        } else {
            btn.classList.remove('relay-on');
            btn.classList.add('relay-off');
        }

        // Update tooltip
        const config = relayConfig[`relay${relayNum}`];
        btn.title = `${config.name} (${config.type}) - ${state ? 'ON' : 'OFF'}`;
    }

    function updateAllRelayButtons(data) {
        for (let i = 1; i <= 4; i++) {
            const relayData = data[`relay${i}`];
            if (relayData) {
                updateRelayButton(i, relayData.state);
                // Update enabled state
                if (relayConfig[`relay${i}`]) {
                    relayConfig[`relay${i}`].enabled = relayData.enabled !== false;
                }
            }
        }
        // Update button visibility based on enabled state
        updateButtonAppearance();
    }

    console.log('GPIO Relay Control plugin loaded');
})();
</script>
